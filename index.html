<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Pedido via Planilha</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- SheetJS -->
    <script src="xlsx.full.min.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        table th,
        table td {
            padding: 6px !important;
        }

        .header-table th,
        .header-table td {
            border: 1px solid #000 !important;
        }

        .autocomplete-list .autocomplete-item:hover {
            background: #eee;
        }
    </style>
</head>

<body class="bg-light">

<div class="container py-4">

    <h3 class="mb-3 text-center">Montar Pedido</h3>

    <!-- CABEÇALHO -->
    <div class="table-responsive">
        <table class="table table-bordered header-table">
            <tr class="table-dark">
                <th>COTAÇÃO</th>
                <th>NOME DE QUEM ESTÁ FAZENDO</th>
                <th>DATA DE EMISSÃO</th>
            </tr>

            <tr>
                <td>
                    <select id="empresa" class="form-select">
                        <option value="Maia">Maia</option>
                        <option value="Cindini">Cindini</option>
                    </select>
                </td>
                <td>
                    <input id="vendedor" type="text" class="form-control">
                </td>
                <td class="text-center">
                    <span id="dataEmissao"></span>
                </td>
            </tr>

            <tr>
                <td>CLIENTE:</td>
                <td><input id="cliente" type="text" class="form-control"></td>
                <td></td>
            </tr>

            <tr>
                <td>PRAZO:</td>
                <td><input id="prazo" type="text" class="form-control"></td>
                <td></td>
            </tr>

            <tr>
                <td>VALIDADE:</td>
                <td><input id="validade" type="text" class="form-control"></td>
                <td></td>
            </tr>
        </table>
    </div>

    <div class="d-grid gap-2 mb-3">
        <button onclick="exportPDF()" class="btn btn-primary btn-lg">Exportar PDF</button>
    </div>

    <!-- TABELA PRODUTOS -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
            <tr>
                <th>Produto</th>
                <th>Volume/Cx</th>
                <th>MK%</th>
                <th>Cotação</th>
                <th>Custo</th>
                <th>Preço Venda</th>
                <th>MK Venda (%)</th>
            </tr>
            </thead>
            <tbody id="rows"></tbody>
        </table>
    </div>

    <div class="d-grid gap-2">
        <button onclick="addRow()" class="btn btn-success">Adicionar Linha</button>
    </div>

</div>


<script>
    document.getElementById("dataEmissao").innerText =
        new Date().toLocaleDateString("pt-BR");

    let produtos = [];
    let baseRel = [];

    // ==============================
    // LER A PLANILHA base.xlsx
    // ==============================
    fetch("base.xlsx")
        .then(r => r.arrayBuffer())
        .then(buf => {
            const wb = XLSX.read(buf, { type: "array" });
            const ws = wb.Sheets["base de dados Rel4426"];
            const json = XLSX.utils.sheet_to_json(ws, { header: 1 });

            for (let i = 1; i < json.length; i++) {
                const G = json[i][6];
                const O = json[i][14];
                if (G) {
                    produtos.push(G);
                    baseRel.push({ produto: G, custo: O });
                }
            }

            addRow();
        });

    function buscarCusto(prod) {
        const item = baseRel.find(x => x.produto === prod);
        return item ? item.custo : "";
    }

    function calcCotacao(custo, mk) {
        custo = parseFloat(custo);
        mk = parseFloat(mk);
        if (isNaN(custo) || isNaN(mk)) return "";
        return (custo + (custo * mk / 100)).toFixed(2);
    }

    // ==============================
    // AUTOCOMPLETE
    // ==============================
    function attachAutocomplete(input, listBox, onSelect) {
        input.addEventListener("input", () => {
            const val = input.value.toLowerCase();
            listBox.innerHTML = "";

            if (!val) {
                listBox.style.display = "none";
                return;
            }

            const filtered = produtos.filter(p =>
                p.toLowerCase().includes(val)
            );

            if (filtered.length === 0) {
                listBox.style.display = "none";
                return;
            }

            filtered.forEach(produto => {
                const item = document.createElement("div");
                item.className = "p-2 autocomplete-item";
                item.style.cursor = "pointer";
                item.innerText = produto;

                item.onclick = () => {
                    input.value = produto;
                    listBox.style.display = "none";
                    onSelect(produto);
                };

                listBox.appendChild(item);
            });

            listBox.style.display = "block";
        });

        document.addEventListener("click", (e) => {
            if (!input.contains(e.target) && !listBox.contains(e.target)) {
                listBox.style.display = "none";
            }
        });
    }

    // ==============================
    // ADICIONAR LINHA
    // ==============================
    function addRow() {
        const tbody = document.getElementById("rows");
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td style="position: relative;">
                <input type="text" class="form-control produto_input" placeholder="Digite para buscar...">
                <div class="autocomplete-list border bg-white position-absolute w-100"
                     style="z-index: 1000; max-height:180px; overflow-y:auto; display:none;"></div>
            </td>

            <td><input type="number" class="form-control volume"></td>

            <td><input type="number" class="form-control mk" step="0.01"></td>

            <td><input type="text" class="form-control cotacao" readonly></td>

            <td><input type="text" class="form-control custo" readonly></td>

            <td><input type="number" class="form-control preco_venda" step="0.01"></td>

            <td><input type="text" class="form-control mk_venda" readonly></td>
        `;

        tbody.appendChild(tr);

        const input = tr.querySelector(".produto_input");
        const listBox = tr.querySelector(".autocomplete-list");

        attachAutocomplete(input, listBox, () => updateRow(tr));

        tr.querySelector(".mk").oninput = () => updateRow(tr);
        tr.querySelector(".preco_venda").oninput = () => updateRow(tr);
    }

    // ==============================
    // ATUALIZA A LINHA
    // ==============================
    function updateRow(tr) {
        const produto = tr.querySelector(".produto_input").value;
        const mk = tr.querySelector(".mk").value;
        const custo = buscarCusto(produto);
        const precoVenda = tr.querySelector(".preco_venda").value;

        tr.querySelector(".custo").value = custo;
        tr.querySelector(".cotacao").value = calcCotacao(custo, mk);

        let mkVenda = "";
        if (custo && precoVenda && parseFloat(custo) > 0) {
            mkVenda = ((parseFloat(precoVenda) / parseFloat(custo) - 1) * 100).toFixed(2) + "%";
        }

        tr.querySelector(".mk_venda").value = mkVenda;
    }

    // ==============================
    // EXPORTAR PDF
    // ==============================
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(12);
        doc.text("COTAÇÃO", 10, 10);

        doc.setFontSize(10);

        doc.text("Empresa: " + document.getElementById("empresa").value, 10, 20);
        doc.text("Vendedor: " + document.getElementById("vendedor").value, 10, 27);
        doc.text("Cliente: " + document.getElementById("cliente").value, 10, 34);
        doc.text("Prazo: " + document.getElementById("prazo").value, 10, 41);
        doc.text("Validade: " + document.getElementById("validade").value, 10, 48);

        doc.text("Data de Emissão: " + document.getElementById("dataEmissao").innerText, 140, 20);

        const linhas = [];
        const trs = document.querySelectorAll("#rows tr");

        trs.forEach(tr => {
            const produto = tr.querySelector(".produto_input")?.value || "";
            const volume = tr.querySelector(".volume")?.value || "";
            const cotacao = tr.querySelector(".cotacao")?.value || "";

            linhas.push([produto, volume, cotacao]);
        });

        doc.autoTable({
            startY: 60,
            head: [["Produto", "Volume", "Cotação"]],
            body: linhas,
            styles: { fontSize: 9 },
            headStyles: { fillColor: [50, 50, 50] }
        });

        doc.save("pedido.pdf");
    }
</script>

</body>
</html>
